#!/bin/bash

# Requires: SynthLib2Tester and $SOLVER in path

SEMANTIC_CHECK_TIMEOUT=10
SEMANTIC_SOLVER=cvc4

SOLVEROUT=$1
SYGUSBENCHNAME=$2

# Ensure that files exist
if [ ! -e "$SOLVEROUT" ];
then
  echo "error (could not find solver output file)"
  exit 1
fi
if [ ! -e "$SYGUSBENCHNAME" ];
then
  echo "error (could not find reference sygus file)"
  exit 1
fi

# Run the SynthLib2Tester tool to check grammar
#echo "[debug] Run SynthLib2Tester to check grammar..."
SynthLib2Tester $SOLVEROUT $SYGUSBENCHNAME > temp-check-syntax.txt

#cat temp-check-syntax.txt | grep result

# If it adheres to grammar (is this right?)
if grep -q adheres=true temp-check-syntax.txt;
then
  #echo "[debug] Run SMT solver to check semantic correctness..."
  ulimit -t $SEMANTIC_CHECK_TIMEOUT;$SEMANTIC_SOLVER --lang=smt2 __sygus_grmrchecker_output.smt >& temp-check-semantic.txt
  # grep for unsat/sat here
  if grep -q unsat temp-check-semantic.txt;
  then
    echo "FAIL-SEMANTIC-UNSAT"
  elif grep -q sat temp-check-semantic.txt;
  then
    echo "SUCCESS"
  else
    echo "FAIL-SEMANTIC"
  fi
else
  echo "FAIL-SYNTAX"

fi

#echo "[debug] Finished"
